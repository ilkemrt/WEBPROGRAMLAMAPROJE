@model FitnessCenter.Web.Models.ViewModels.AppointmentCreateViewModel

@{
    ViewData["Title"] = "Randevu Al";
}


<h2 class="mb-4">Randevu Al</h2>

<div class="card shadow p-4">

    <div class="alert alert-info mb-4">
        <h5 class="mb-1">@Model.ServiceName</h5>
        <div>
            <strong>Süre:</strong> @Model.Duration dk |
            <strong>Ücret:</strong> @Model.Price ₺
        </div>
    </div>

    <form asp-action="Create" method="post">
        @Html.AntiForgeryToken()

        <input type="hidden" asp-for="ServiceId" />

        <!-- ANTRENÖR -->
        <div class="mb-3">
            <label class="form-label">Antrenör</label>
            <select asp-for="TrainerId" class="form-select">
                <option value="">-- Antrenör Seçiniz --</option>
                @foreach (var t in Model.AvailableTrainers)
                {
                    <option value="@t.Id">@t.FullName</option>
                }
            </select>
            <span asp-validation-for="TrainerId" class="text-danger"></span>
        </div>

        <!-- TARİH -->
        <div class="mb-3">
            <label class="form-label">Tarih</label>
            <input asp-for="Date" type="date" class="form-control" />
            <span asp-validation-for="Date" class="text-danger"></span>
        </div>

        <!-- SAAT -->
        <div class="mb-3">
            <label class="form-label">Müsait Saatler</label>
            <div id="hoursContainer" class="d-flex flex-wrap gap-2"></div>
        </div>

        <input type="hidden" asp-for="StartHour" id="startHourInput" />

        <button type="submit" class="btn btn-success mt-3">
            Randevu Oluştur
        </button>
    </form>
</div>

<script>
    const trainer = document.getElementById("TrainerId");
    const date = document.getElementById("Date");
    const serviceInput = document.getElementById("ServiceId"); // Hidden input'u yakala (ASP-FOR ServiceId id'si genelde ServiceId olur)
    const hoursDiv = document.getElementById("hoursContainer");
    const hiddenHour = document.getElementById("startHourInput");

    trainer.addEventListener("change", loadHours);
    date.addEventListener("change", loadHours);

    function loadHours() {
        // serviceInput.value kontrolünü de ekleyelim
        if (!trainer.value || !date.value || !serviceInput.value) return;

        // URL'e serviceId parametresini de ekliyoruz
        const url = `/Appointment/GetAvailableHours?trainerId=${trainer.value}&serviceId=${serviceInput.value}&date=${date.value}`;

        fetch(url)
            .then(r => r.json())
            .then(hours => {
                hoursDiv.innerHTML = "";

                if (hours.length === 0) {
                    hoursDiv.innerHTML = "<span class='text-danger'>Müsait saat yok</span>";
                    return;
                }

                hours.forEach(h => {
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = "btn btn-outline-success";
                    btn.innerText = h;

                    btn.onclick = () => {
                        document.querySelectorAll("#hoursContainer button")
                            .forEach(x => x.classList.remove("active"));
                        btn.classList.add("active");
                        hiddenHour.value = h;
                    };

                    hoursDiv.appendChild(btn);
                });
            });
    }
</script>

