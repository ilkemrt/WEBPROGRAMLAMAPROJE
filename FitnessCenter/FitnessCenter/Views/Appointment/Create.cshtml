@model FitnessCenter.Web.Models.ViewModels.AppointmentCreateViewModel

@{
    ViewData["Title"] = "Randevu Al";
}

<h2 class="mb-4">Randevu Al</h2>

<div class="card shadow p-4">

    <div class="alert alert-info mb-4">
        <h5 class="mb-1">@Model.ServiceName</h5>
        <div>
            <strong>Süre:</strong> @Model.Duration dk |
            <strong>Ücret:</strong> @Model.Price ₺
        </div>
    </div>

    <form asp-action="Create" method="post" id="appointmentForm">
        @Html.AntiForgeryToken()

        <input type="hidden" asp-for="ServiceId" />
        <input type="hidden" asp-for="StartHour" id="startHourInput" />

        <!-- ANTRENÖR -->
        <div class="mb-3">
            <label class="form-label">Antrenör</label>
            <select asp-for="TrainerId" class="form-select" id="TrainerId">
                <option value="">-- Antrenör Seçiniz --</option>
                @foreach (var t in Model.AvailableTrainers)
                {
                    <option value="@t.Id">@t.FullName</option>
                }
            </select>
            <span asp-validation-for="TrainerId" class="text-danger"></span>
        </div>

        <!-- ANTRENÖR KARTI -->
        <div id="trainerCard" class="card mb-4 d-none shadow">
            <img id="trainerImage"
                 class="img-fluid rounded-top"
                 style="max-height: 420px; width: 100%; object-fit: contain; background:#f8f9fa;" />

            <div class="card-body">
                <h5 id="trainerName" class="fw-bold mb-2"></h5>
                <p id="trainerBio" class="text-muted mb-0"></p>
            </div>
        </div>

        <!-- TARİH -->
        <div class="mb-3">
            <label class="form-label">Tarih</label>
            <input asp-for="Date" type="date" class="form-control" id="Date" />
        </div>

        <!-- SAAT -->
        <div id="hourWarning" class="alert alert-danger d-none">
            Lütfen randevu saati seçiniz.
        </div>

        <div class="mb-3">
            <label class="form-label">Müsait Saatler</label>
            <div id="hoursContainer" class="d-flex flex-wrap gap-2"></div>
        </div>

        <button type="button" class="btn btn-success w-100" id="submitBtn">
            Randevu Oluştur
        </button>
    </form>
</div>

@section Scripts {
    <script>
        const trainerSelect = document.getElementById("TrainerId");
        const dateInput = document.getElementById("Date");
        const serviceInput = document.getElementById("ServiceId");
        const hoursDiv = document.getElementById("hoursContainer");
        const hiddenHour = document.getElementById("startHourInput");
        const submitBtn = document.getElementById("submitBtn");
        const hourWarning = document.getElementById("hourWarning");

        const trainerCard = document.getElementById("trainerCard");
        const trainerName = document.getElementById("trainerName");
        const trainerBio = document.getElementById("trainerBio");
        const trainerImage = document.getElementById("trainerImage");

        // -------- INITIAL STATE --------
        window.addEventListener("load", () => {
            if (!trainerSelect.value) {
                resetTrainerUI();
            } else {
                loadTrainerInfo();
            }
        });

        // -------- EVENTS --------
        trainerSelect.addEventListener("change", () => {
            resetHours();

            if (!trainerSelect.value) {
                resetTrainerUI();
                return;
            }

            loadTrainerInfo();
            if (dateInput.value) {
                loadHours();
            }
        });

        dateInput.addEventListener("change", () => {
            resetHours();
            if (trainerSelect.value) {
                loadHours();
            }
        });

        // -------- FONKSİYONLAR --------
        function resetTrainerUI() {
            trainerCard.classList.add("d-none");
            trainerName.innerText = "";
            trainerBio.innerText = "";
            trainerImage.src = "";
        }

        function resetHours() {
            hiddenHour.value = "";
            hoursDiv.innerHTML = "";
            hourWarning.classList.add("d-none");
        }

        function loadTrainerInfo() {
            fetch(`/Appointment/GetTrainerInfo?trainerId=${trainerSelect.value}`)
                .then(r => r.json())
                .then(t => {
                    trainerCard.classList.remove("d-none");
                    trainerName.innerText = t.fullName;
                    trainerBio.innerText = t.biography ?? "";
                    trainerImage.src = t.imageUrl ?? "https://via.placeholder.com/400x260";
                });
        }

        function loadHours() {
            if (!trainerSelect.value || !dateInput.value) return;

            const url = `/Appointment/GetAvailableHours?trainerId=${trainerSelect.value}&serviceId=${serviceInput.value}&date=${dateInput.value}`;

            fetch(url)
                .then(r => r.json())
                .then(hours => {
                    hoursDiv.innerHTML = "";

                    if (hours.length === 0) {
                        hoursDiv.innerHTML = "<span class='text-danger'>Müsait saat yok</span>";
                        return;
                    }

                    hours.forEach(h => {
                        const btn = document.createElement("button");
                        btn.type = "button";
                        btn.className = "btn btn-outline-success";
                        btn.innerText = h;

                        btn.onclick = () => {
                            document.querySelectorAll("#hoursContainer button")
                                .forEach(x => x.classList.remove("active"));
                            btn.classList.add("active");
                            hiddenHour.value = h;
                        };

                        hoursDiv.appendChild(btn);
                    });
                });
        }

       
        submitBtn.addEventListener("click", () => {
            if (!trainerSelect.value) {
                alert("Lütfen antrenör seçiniz.");
                return;
            }

            if (!hiddenHour.value) {
                hourWarning.classList.remove("d-none");
                hourWarning.scrollIntoView({ behavior: "smooth" });
                return;
            }

            submitBtn.closest("form").submit();
        });
    </script>


    <partial name="_ValidationScriptsPartial" />
}
